# See: https://circleci.com/docs/2.0/language-python/

version: 2
jobs:

  build-docs:
    working_directory: ~/repo
    docker:
      - image: cimg/python:3.10-node

    steps:
      - checkout

      - run:
          name: Install Python dependencies
          command: |
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip wheel setuptools
            pip install -r requirements.txt

      - restore_cache:
          keys:
            - cache-data

      - run:
          name: Build site
          no_output_timeout: 30m
          command: |
            # NOTE: blas multithreading behaves badly on circleci
            export OMP_NUM_THREADS=1
            source venv/bin/activate
            # Construct the BASE_URL using the CIRCLE_WORKFLOW_JOB_ID
            export BASE_URL="/output/job/${CIRCLE_WORKFLOW_JOB_ID}/artifacts/0/_build/html"

            # Output the BASE_URL for debugging purposes
            echo "BASE_URL is set to $BASE_URL"

            # Run your myst build command
            myst build --html --execute

      - save_cache:
          key: cache-data
          paths:
            - _data

      - store_artifacts:
          path: _build/html

      - persist_to_workspace:
          root: _build
          paths: html

  deploy-docs:
    working_directory: ~/repo
    docker:
      - image: cimg/python:3.10-node
    steps:
      - checkout

      - attach_workspace:
          at: _build

      - run:
          name: install deploy deps
          command : |
            python3 -m pip install --user ghp-import

            # TODO!
            #      - run:
            #          name: configure git
            #          command: |
            #            git config --global user.name "ci-doc-deploy-bot"
            #            git config --global user.email "ci-doc-deploy-bot@nomail"
            #            git config --global push.default simple
            #
            #      - add_ssh_keys:
            #          fingerprints:
            #            5c:54:62:37:75:7f:4d:14:f4:07:82:1c:50:0d:ee:9b
            #
            #      - run:
            #          name: deploy to gh-pages
            #          command: |
            #            ghp-import -n -f -p -m "[skip ci] docs build of $CIRCLE_SHA1" site/_build/html


workflows:
  version: 2
  build:
    jobs:
      - build-docs
      - deploy-docs:
          requires:
            - build-docs
          filters:
            branches:
              only: main
